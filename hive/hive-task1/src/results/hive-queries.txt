### creating partitioned table from external hdfs table with expedia data 
CREATE TABLE hotel_visit (
id bigint,
user_id int,
srch_ci string,
srch_co string
) 
PARTITIONED BY (hotel_id bigint);

INSERT OVERWRITE TABLE hotel_visit PARTITION (hotel_id)
SELECT id, user_id, srch_ci, srch_co, hotel_id
FROM hdfs_expedia;



### Top 10 hotels with max absolute difference variance temperature by month
EXPLAIN FORMATTED SELECT tbl.name AS name, tbl.wthr_year AS year, tbl.wthr_month AS month, MAX(tbl.tmpr_diff) AS max_tmpr_diff FROM(
   SELECT name, wthr_year, wthr_month, ROUND(ABS(MAX(avg_tmpr_c) - MIN(avg_tmpr_c)), 2) AS tmpr_diff 
   FROM hotel_weather 
   GROUP BY name, wthr_year, wthr_month
) tbl
GROUP BY tbl.name, tbl.wthr_year, tbl.wthr_month
ORDER BY MAX(tbl.tmpr_diff) DESC
LIMIT 10;

### Top 10 busy (e.g. with the biggest visits count) hotels for each month. 
### If visit dates refer to several months it should be counted for all affected months.
select tbl.hotel_id,tbl.year,month,count(*) as cnt from (
select t.hotel_id, year(add_months(t.srch_ci,pe.i)) as year, month(add_months(t.srch_ci,pe.i)) as month
from hdfs_expedia t
lateral view 
posexplode(split(space((cast(year(t.srch_co) as int) - cast(year(t.srch_ci) as int) ) * 12 +  (cast(month(t.srch_co) as int) - cast(month(t.srch_ci) as int))),' ')) pe as i, x
) tbl
group by hotel_id,year,month
order by cnt desc
limit 10;



### For visits with extended stay (more than 7 days) 
### average temperature during stay.
select t1.id, t1.user_id, t1.hotel_id, 
ROUND(AVG(t2.avg_tmpr_c), 1) as avg_tmpr, 
t3.tmpr_diff as tmpr_diff
FROM (SELECT t.id, t.user_id, t.hotel_id, date_add(t.srch_ci,pe.i) as visit_date
FROM hdfs_expedia t
lateral view
posexplode(split(space(datediff(t.srch_co,t.srch_ci)),' ')) pe as i,x
WHERE datediff(to_date(t.srch_co), to_date(t.srch_ci)) > 7
) t1
JOIN kafka_hotel_weather t2
ON t1.hotel_id = t2.hotelid
AND t1.visit_date = t2.wthr_date
JOIN (
SELECT tt1.id, ROUND((tt2.avg_tmpr - tt3.avg_tmpr), 1) as tmpr_diff
FROM hdfs_expedia tt1
JOIN hotel_weather tt2
ON tt1.hotel_id = tt2.hotelid
AND tt1.srch_co = tt2.wthr_date
JOIN hotel_weather tt3
ON tt1.hotel_id = tt3.hotelid
AND tt1.srch_ci = tt3.wthr_date
) t3
ON t1.id = t3.id
GROUP BY t1.id,t1.user_id,t1.hotel_id,t3.tmpr_diff;